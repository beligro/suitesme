# Руководство по развертыванию SuitesMe

Этот документ содержит инструкции по развертыванию приложения SuitesMe с использованием GitHub Actions или ручного развертывания.

## Содержание

- [Предварительные требования](#предварительные-требования)
- [Варианты развертывания](#варианты-развертывания)
  - [Автоматическое развертывание с GitHub Actions](#автоматическое-развертывание-с-github-actions)
  - [Ручное развертывание](#ручное-развертывание)
- [Переменные окружения](#переменные-окружения)
- [Устранение неполадок](#устранение-неполадок)

## Предварительные требования

Перед развертыванием приложения убедитесь, что у вас есть:

- Сервер с установленными Docker и Docker Compose
- Доступ к GitHub Container Registry (GHCR)
- SSH-доступ к вашему серверу
- Необходимые переменные окружения в файле `.env`

## Варианты развертывания

### Автоматическое развертывание с GitHub Actions

Репозиторий включает рабочий процесс GitHub Actions, который автоматизирует процесс развертывания. Когда вы отправляете изменения в ветку `main` или вручную запускаете рабочий процесс, он:

1. Собирает Docker-образы для всех сервисов
2. Отправляет образы в GitHub Container Registry
3. Разворачивает приложение на вашем сервере

#### Настройка

1. **Настройка секретов GitHub**

   Настройте следующие секреты в вашем репозитории GitHub:

   - `SSH_HOST`: Имя хоста или IP-адрес вашего сервера
   - `SSH_USERNAME`: Имя пользователя для подключения к серверу по SSH
   - `SSH_PRIVATE_KEY`: Приватный SSH-ключ для аутентификации
   - `ENV_FILE`: Содержимое вашего файла .env со всеми переменными окружения
   - `VITE_API_URL`: URL API для фронтенда (используется при сборке)

   Вы можете использовать предоставленный скрипт для автоматической настройки этих секретов:

   ```bash
   ./setup-github-secrets.sh
   ```

   Этот скрипт требует установки и аутентификации GitHub CLI (`gh`).

2. **Генерация пары SSH-ключей**

   Если у вас нет пары SSH-ключей, вы можете сгенерировать её:

   ```bash
   ssh-keygen -t ed25519 -C "github-actions"
   ```

   Добавьте публичный ключ в файл `~/.ssh/authorized_keys` на вашем сервере:

   ```bash
   cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys
   ```

   Затем добавьте приватный ключ в качестве секрета `SSH_PRIVATE_KEY` в GitHub. Скрипт `setup-github-secrets.sh` может помочь вам с этим процессом.

3. **Запуск развертывания**

   - **Автоматически**: Отправьте изменения в ветку `main`
   - **Вручную**: Перейдите в Actions > Deploy Application > Run workflow

Для получения дополнительной информации см. [README рабочего процесса GitHub Actions](.github/workflows/README.ru.md).

### Ручное развертывание

Вы также можете развернуть приложение вручную, используя предоставленный скрипт развертывания.

1. **Клонируйте репозиторий на ваш сервер**

   ```bash
   git clone https://github.com/beligro/suitesme.git
   cd suitesme
   ```

2. **Создайте или обновите файл `.env`**

   Убедитесь, что все необходимые переменные окружения установлены.

3. **Запустите скрипт развертывания**

   ```bash
   ./deploy.sh <github_token>
   ```

   Замените `<github_token>` на персональный токен доступа GitHub, который имеет разрешения на загрузку из GHCR.

## Переменные окружения

Приложение требует установки нескольких переменных окружения в файле `.env`:

- Конфигурация базы данных:
  - `DB_HOST`
  - `DB_USER`
  - `DB_PASSWORD`
  - `DB_NAME`

- Конфигурация MinIO:
  - `MINIO_ROOT_USER`
  - `MINIO_ROOT_PASSWORD`
  - `STYLE_PHOTO_BUCKET`
  - `STYLE_PDF_BUCKET`

- Конфигурация фронтенда:
  - `VITE_API_URL`

## Устранение неполадок

Если вы столкнулись с проблемами при развертывании:

1. **Проверьте установку Docker и Docker Compose**

   ```bash
   docker --version
   docker-compose --version
   ```

2. **Проверьте доступ к GitHub Container Registry**

   ```bash
   docker login ghcr.io -u <username> -p <github_token>
   ```

3. **Проверьте логи Docker Compose**

   ```bash
   docker-compose -f docker-compose.prod.yml logs
   ```

4. **Проверьте переменные окружения**

   Убедитесь, что все необходимые переменные окружения правильно установлены в вашем файле `.env`.

5. **Проверьте логи GitHub Actions**

   Если вы используете GitHub Actions, проверьте логи выполнения рабочего процесса на наличие ошибок.
