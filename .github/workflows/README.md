# Рабочий процесс развертывания GitHub Actions

Этот репозиторий содержит рабочий процесс GitHub Actions, который автоматизирует процесс развертывания приложения SuitesMe. Рабочий процесс собирает Docker-образы, отправляет их в GitHub Container Registry (GHCR) и разворачивает их на вашем сервере.

## Обзор рабочего процесса

Рабочий процесс состоит из двух основных задач:

1. **Сборка и отправка Docker-образов**: Собирает Docker-образы для всех сервисов (backend, frontend, admin, ml) и отправляет их в GitHub Container Registry.
2. **Развертывание на сервере**: Подключается к вашему серверу через SSH, настраивает необходимые файлы и разворачивает приложение с помощью Docker Compose.

## Необходимые секреты

Перед использованием этого рабочего процесса вам необходимо настроить следующие секреты в вашем репозитории GitHub:

| Имя секрета | Описание |
|-------------|----------|
| `SSH_HOST` | Имя хоста или IP-адрес вашего сервера |
| `SSH_USERNAME` | Имя пользователя для подключения к серверу по SSH |
| `SSH_PRIVATE_KEY` | Приватный SSH-ключ для аутентификации |
| `ENV_FILE` | Содержимое вашего файла .env со всеми переменными окружения |
| `VITE_API_URL` | URL API для фронтенда (используется при сборке) |

## Как настроить секреты

Вы можете настроить необходимые секреты двумя способами:

### Использование скрипта setup-github-secrets.sh (Рекомендуется)

Мы предоставляем скрипт, который автоматизирует процесс настройки секретов GitHub:

```bash
./setup-github-secrets.sh
```

Этот скрипт:
1. Проверяет, установлен ли GitHub CLI и аутентифицирован ли он
2. Запрашивает SSH-хост, имя пользователя и путь к приватному ключу
3. Помогает сгенерировать пару SSH-ключей, если необходимо
4. Настраивает секрет ENV_FILE из вашего локального файла .env
5. Устанавливает все необходимые секреты в вашем репозитории GitHub

Скрипт требует установки и аутентификации GitHub CLI (`gh`).

### Ручная настройка

Если вы предпочитаете настраивать секреты вручную:

1. Перейдите в ваш репозиторий GitHub
2. Нажмите на "Settings" > "Secrets and variables" > "Actions"
3. Нажмите на "New repository secret"
4. Добавьте каждый из необходимых секретов

#### Настройка SSH_PRIVATE_KEY

Для генерации пары SSH-ключей:

```bash
ssh-keygen -t ed25519 -C "github-actions"
```

Добавьте публичный ключ в файл `~/.ssh/authorized_keys` на вашем сервере:

```bash
cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys
```

Затем добавьте приватный ключ (содержимое файла `~/.ssh/id_ed25519`) в качестве секрета `SSH_PRIVATE_KEY` в GitHub.

#### Настройка ENV_FILE

Секрет `ENV_FILE` должен содержать все содержимое вашего файла `.env`, включая все переменные окружения, необходимые для вашего приложения.

## Запуск рабочего процесса

Рабочий процесс может быть запущен двумя способами:

1. **Автоматически**: При отправке изменений в ветку `main`
2. **Вручную**: С использованием события "workflow_dispatch" в интерфейсе GitHub Actions

Для ручного запуска рабочего процесса:

1. Перейдите в ваш репозиторий GitHub
2. Нажмите на "Actions"
3. Выберите "Deploy Application" из списка рабочих процессов
4. Нажмите на "Run workflow"
5. Выберите окружение (production или staging)
6. Нажмите "Run workflow"

## Настройка рабочего процесса

Если вам нужно настроить рабочий процесс, вы можете отредактировать файл `.github/workflows/deploy.yml`. Некоторые распространенные настройки включают:

- Изменение ветки, которая запускает рабочий процесс
- Добавление дополнительных сервисов для сборки и развертывания
- Изменение скрипта развертывания
- Добавление дополнительных шагов для тестирования или валидации

## Устранение неполадок

Если вы столкнулись с проблемами с рабочим процессом:

1. Проверьте логи выполнения рабочего процесса в GitHub Actions
2. Убедитесь, что все секреты правильно настроены
3. Убедитесь, что на вашем сервере установлены Docker и Docker Compose
4. Проверьте, что ваш сервер имеет достаточные разрешения для загрузки из GitHub Container Registry
